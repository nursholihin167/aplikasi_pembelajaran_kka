<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS Kimia - Kelas Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #fefce8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden relative">

    <!-- HALAMAN AUTH (LOGIN & DAFTAR) -->
    <div id="auth-page" class="flex-1 flex items-center justify-center p-4 bg-[#fefce8]">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-sm:p-6 max-w-sm text-center fade-in border border-yellow-100">
            <div id="auth-logo" class="w-20 h-20 bg-amber-500 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl shadow-inner border-4 border-white overflow-hidden">
                <img src="https://i.imgur.com/xjrqTvP.jpeg" class="w-full h-full object-cover">
            </div>
            <h1 id="auth-title" class="text-2xl font-bold text-amber-900">LMS Kimia</h1>
            <p id="auth-subtitle" class="text-xs text-amber-700 mb-6 italic">Selamat Datang di Portal Pembelajaran</p>

            <!-- Form Login -->
            <div id="login-section">
                <form id="login-form" class="space-y-4 text-left">
                    <input type="text" id="login-username" class="w-full px-4 py-3 rounded-xl border border-yellow-100 bg-amber-50 focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Username" required>
                    <input type="password" id="login-password" class="w-full px-4 py-3 rounded-xl border border-yellow-100 bg-amber-50 focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Password" required>
                    <button type="submit" class="w-full bg-amber-500 text-white font-bold py-3 rounded-xl hover:bg-amber-600 shadow-lg transition">Masuk</button>
                </form>
                <p class="mt-6 text-sm text-gray-500">Belum punya akun? <a href="#" onclick="toggleAuth(false)" class="text-amber-600 font-bold hover:underline">Daftar Siswa</a></p>
            </div>

            <!-- Form Daftar -->
            <div id="register-section" class="hidden">
                <form id="register-form" class="space-y-4 text-left">
                    <input type="text" id="reg-fullname" class="w-full px-4 py-3 rounded-xl border border-yellow-100 bg-amber-50 focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Nama Lengkap" required>
                    <input type="text" id="reg-username" class="w-full px-4 py-3 rounded-xl border border-yellow-100 bg-amber-50 focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Pilih Username" required>
                    <input type="password" id="reg-password" class="w-full px-4 py-3 rounded-xl border border-yellow-100 bg-amber-50 focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Password Baru" required>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 shadow-lg transition">Buat Akun Siswa</button>
                </form>
                <p class="mt-6 text-sm text-gray-500">Sudah punya akun? <a href="#" onclick="toggleAuth(true)" class="text-amber-600 font-bold hover:underline">Kembali Login</a></p>
            </div>
        </div>
    </div>

    <!-- DASHBOARD UTAMA -->
    <div id="app-dashboard" class="hidden h-full flex flex-col md:flex-row bg-[#fefce8]">
        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-amber-950 text-amber-50 flex flex-col shadow-2xl z-20">
            <div class="p-6 border-b border-amber-900 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full overflow-hidden bg-amber-900">
                    <img src="https://i.imgur.com/xjrqTvP.jpeg" class="w-full h-full object-cover">
                </div>
                <span class="font-bold text-lg">LMS Kimia</span>
            </div>
            <nav class="flex-1 p-4 overflow-y-auto">
                <ul id="main-menu-list" class="space-y-2"></ul>
            </nav>
            <div class="p-4 border-t border-amber-900 text-[10px] text-amber-600 text-center">
                Masuk sebagai: <span id="current-user-display" class="font-bold text-amber-400"></span>
            </div>
        </aside>
        
        <!-- Area Konten -->
        <main id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8"></main>
    </div>

    <script>
        let currentUser = null;
        
        // Inisialisasi Database (Local Storage Mockup)
        const db = {
            users: JSON.parse(localStorage.getItem('lms_users')) || [
                { username: 'guru', password: '123', name: 'Bu Lina', role: 'Guru' },
                { username: 'siswa', password: '123', name: 'Budi Santoso', role: 'Siswa' }
            ],
            materi: [
                { id: 1, judul: 'Struktur Atom', konten: 'Atom terdiri dari inti (proton, neutron) dan elektron.' }
            ],
            quizzes: JSON.parse(localStorage.getItem('lms_quizzes')) || [
                { 
                    id: 101, 
                    judul: 'Kuis Kimia Dasar', 
                    status: 'Aktif',
                    soal: [
                        { id: 1, tipe: 'PG', teks: 'Zat yang tidak dapat dibagi lagi secara kimia adalah?', opsi: ['Molekul', 'Senyawa', 'Atom', 'Campuran', 'Ion'], kunci: 'Atom', skor: 10 },
                        { id: 2, tipe: 'Essay', teks: 'Jelaskan teori atom Dalton!', skor: 20 }
                    ]
                }
            ],
            jawabanSiswa: JSON.parse(localStorage.getItem('lms_jawaban')) || []
        };

        function saveData() {
            localStorage.setItem('lms_users', JSON.stringify(db.users));
            localStorage.setItem('lms_quizzes', JSON.stringify(db.quizzes));
            localStorage.setItem('lms_jawaban', JSON.stringify(db.jawabanSiswa));
        }

        // Toggle Login/Daftar
        function toggleAuth(isLogin) {
            document.getElementById('login-section').classList.toggle('hidden', !isLogin);
            document.getElementById('register-section').classList.toggle('hidden', isLogin);
            document.getElementById('auth-title').innerText = isLogin ? 'LMS Kimia' : 'Daftar Baru';
        }

        // Handle Registrasi
        document.getElementById('register-form').onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('reg-fullname').value;
            const user = document.getElementById('reg-username').value;
            const pass = document.getElementById('reg-password').value;

            if (db.users.find(u => u.username === user)) {
                return alert('Username sudah digunakan!');
            }

            db.users.push({ username: user, password: pass, name: name, role: 'Siswa' });
            saveData();
            alert('Pendaftaran Berhasil! Silakan Login.');
            toggleAuth(true);
        };

        // Handle Login
        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            const user = db.users.find(usr => usr.username === u && usr.password === p);
            
            if (user) {
                currentUser = user;
                document.getElementById('auth-page').classList.add('hidden');
                document.getElementById('app-dashboard').classList.remove('hidden');
                document.getElementById('current-user-display').innerText = `${user.name} (${user.role})`;
                renderMenu();
                renderDashboard();
            } else {
                alert('Username atau password salah!');
            }
        };

        function renderMenu() {
            const list = document.getElementById('main-menu-list');
            let m = `
                <li><button onclick="renderDashboard()" class="w-full text-left p-3 rounded-xl hover:bg-amber-900 flex items-center gap-3"><i class="fas fa-home w-5 text-amber-400"></i> Dashboard</button></li>
                <li><button onclick="renderMateri()" class="w-full text-left p-3 rounded-xl hover:bg-amber-900 flex items-center gap-3"><i class="fas fa-book w-5 text-amber-400"></i> Materi</button></li>
                <li><button onclick="renderListKuis()" class="w-full text-left p-3 rounded-xl hover:bg-amber-900 flex items-center gap-3"><i class="fas fa-edit w-5 text-amber-400"></i> Latihan Soal</button></li>
            `;
            if(currentUser.role === 'Guru') {
                m += `
                    <div class="pt-4 border-t border-amber-900 mt-4 opacity-50 text-[10px] uppercase font-bold px-3 tracking-widest">Administrator</div>
                    <li><button onclick="renderKelolaKuis()" class="w-full text-left p-3 rounded-xl hover:bg-amber-900 flex items-center gap-3"><i class="fas fa-folder-plus w-5 text-green-400"></i> Kelola Kuis</button></li>
                    <li><button onclick="renderPenilaianEssay()" class="w-full text-left p-3 rounded-xl hover:bg-amber-900 flex items-center gap-3"><i class="fas fa-check-circle w-5 text-blue-400"></i> Koreksi Essay</button></li>
                `;
            }
            m += `<li><button onclick="location.reload()" class="w-full text-left p-3 rounded-xl hover:bg-red-900 mt-8 flex items-center gap-3 text-red-300"><i class="fas fa-power-off w-5"></i> Keluar</button></li>`;
            list.innerHTML = m;
        }

        function renderDashboard() {
            const totalKuis = db.quizzes.length;
            const totalMateri = db.materi.length;
            document.getElementById('content-area').innerHTML = `<div class="fade-in">
                <h2 class="text-3xl font-bold text-amber-900 mb-2">Halo, ${currentUser.name}!</h2>
                <p class="text-amber-700 mb-8 font-medium">Selamat belajar di portal Kimia digital.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-3xl border border-yellow-200 shadow-sm flex items-center gap-4">
                        <div class="w-12 h-12 bg-amber-100 rounded-2xl flex items-center justify-center text-amber-600 text-xl"><i class="fas fa-pencil-alt"></i></div>
                        <div><p class="text-xs text-gray-500 font-bold uppercase">Kuis Tersedia</p><p class="text-2xl font-black text-amber-900">${totalKuis}</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border border-yellow-200 shadow-sm flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600 text-xl"><i class="fas fa-book-open"></i></div>
                        <div><p class="text-xs text-gray-500 font-bold uppercase">Materi</p><p class="text-2xl font-black text-amber-900">${totalMateri}</p></div>
                    </div>
                </div>
            </div>`;
        }

        function renderListKuis() {
            let html = `<h2 class="text-2xl font-bold text-amber-900 mb-6">Latihan Kimia</h2><div class="grid gap-4">`;
            db.quizzes.forEach(q => {
                const hasil = db.jawabanSiswa.find(j => j.quizId === q.id && j.student === currentUser.name);
                html += `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-yellow-100 flex justify-between items-center fade-in">
                        <div>
                            <h3 class="font-bold text-lg text-amber-800">${q.judul}</h3>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-tight">${q.soal.length} Soal | Maks Skor: ${q.soal.reduce((a,b)=>a+b.skor, 0)}</p>
                        </div>
                        ${hasil ? 
                            `<div class="text-right"><span class="block text-[10px] text-gray-400 uppercase font-bold">Nilai Anda</span><span class="bg-amber-100 text-amber-800 px-4 py-1 rounded-full text-sm font-black">${hasil.nilai !== null ? hasil.nilai : 'Proses Koreksi'}</span></div>` : 
                            `<button onclick="kerjakanKuis(${q.id})" class="bg-amber-500 text-white px-6 py-2 rounded-xl font-bold hover:bg-amber-600 transition shadow-md">Kerjakan</button>`
                        }
                    </div>
                `;
            });
            document.getElementById('content-area').innerHTML = html + `</div>`;
        }

        function kerjakanKuis(id) {
            const quiz = db.quizzes.find(q => q.id === id);
            let html = `<div class="max-w-3xl mx-auto pb-20 fade-in">
                <h2 class="text-2xl font-bold text-amber-900 mb-6">${quiz.judul}</h2>
                <form id="form-kerjakan-kuis" class="space-y-6">`;
            
            quiz.soal.forEach((s, idx) => {
                html += `<div class="bg-white p-6 rounded-3xl shadow-sm border border-yellow-100">
                    <p class="font-bold text-amber-800 mb-4">${idx+1}. ${s.teks} <span class="bg-amber-50 text-amber-600 text-[10px] px-2 py-1 rounded-md ml-1 font-mono">Poin: ${s.skor}</span></p>`;
                
                if(s.tipe === 'PG') {
                    s.opsi.forEach(o => {
                        html += `<label class="flex items-center gap-3 p-3 border rounded-xl mb-2 hover:bg-amber-50 cursor-pointer transition">
                            <input type="radio" name="soal-${s.id}" value="${o}" class="accent-amber-500" required> <span class="text-sm">${o}</span>
                        </label>`;
                    });
                } else {
                    html += `<textarea name="soal-${s.id}-text" class="w-full px-4 py-3 rounded-xl border focus:ring-2 focus:ring-amber-500" placeholder="Ketik jawaban Anda di sini..." required></textarea>`;
                }
                html += `</div>`;
            });

            html += `<button type="submit" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold shadow-xl hover:bg-green-700">Kirim Semua Jawaban</button></form></div>`;
            document.getElementById('content-area').innerHTML = html;

            document.getElementById('form-kerjakan-kuis').onsubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                let detail = [];
                let totalAutoSkor = 0;
                let butuhGuru = false;

                quiz.soal.forEach(s => {
                    let jaw = "";
                    let correct = false;
                    if(s.tipe === 'PG') {
                        jaw = formData.get(`soal-${s.id}`);
                        correct = (jaw === s.kunci);
                        if(correct) totalAutoSkor += s.skor;
                    } else {
                        jaw = formData.get(`soal-${s.id}-text`);
                        butuhGuru = true;
                    }
                    detail.push({ id: s.id, jawabanUser: jaw, isCorrect: correct, skor: (correct ? s.skor : 0) });
                });

                db.jawabanSiswa.push({
                    id: Date.now(), quizId: quiz.id, student: currentUser.name,
                    status: butuhGuru ? 'Pending Koreksi' : 'Selesai',
                    nilai: butuhGuru ? null : totalAutoSkor, detail
                });
                saveData();
                alert('Tugas terkirim!');
                renderListKuis();
            };
        }

        // --- GURU: KELOLA KUIS DENGAN KRITERIA SKOR ---
        function renderKelolaKuis() {
            let html = `<div class="fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-amber-900">Atur Latihan</h2>
                    <button onclick="buatKuisBaru()" class="bg-amber-600 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-md hover:bg-amber-700">+ Tambah Kuis</button>
                </div>
                <div class="grid gap-4">`;
            db.quizzes.forEach(q => {
                html += `<div class="bg-white p-5 rounded-2xl shadow-sm border border-yellow-100 flex justify-between items-center">
                    <div><h4 class="font-bold text-amber-800">${q.judul}</h4><p class="text-xs text-gray-400">${q.soal.length} Soal</p></div>
                    <button onclick="hapusKuis(${q.id})" class="text-red-400 p-2"><i class="fas fa-trash-alt"></i></button>
                </div>`;
            });
            document.getElementById('content-area').innerHTML = html + `</div></div>`;
        }

        function buatKuisBaru() {
            document.getElementById('content-area').innerHTML = `<div class="max-w-2xl mx-auto fade-in pb-20">
                <h2 class="text-2xl font-bold text-amber-900 mb-6">Buat Kuis & Kriteria Skor</h2>
                <div class="bg-white p-8 rounded-3xl shadow-lg border border-yellow-100 space-y-6">
                    <input type="text" id="new-quiz-title" class="w-full px-4 py-3 rounded-xl border bg-amber-50 outline-none font-bold" placeholder="Judul Kuis">
                    <div id="container-soal" class="space-y-6"></div>
                    <button onclick="tambahItemSoal()" class="w-full py-3 border-2 border-dashed border-amber-300 rounded-2xl text-amber-600 font-bold hover:bg-amber-50">+ Tambah Soal</button>
                    <button onclick="saveKuisBaru()" class="w-full bg-amber-900 text-white font-bold py-4 rounded-2xl shadow-xl hover:bg-black transition">Publikasikan Kuis</button>
                </div>
            </div>`;
            tambahItemSoal();
        }

        function tambahItemSoal() {
            const container = document.getElementById('container-soal');
            const qid = Date.now();
            const div = document.createElement('div');
            div.className = "p-5 bg-amber-50/50 rounded-2xl border border-amber-100 item-soal-block relative";
            div.innerHTML = `
                <div class="flex gap-4 mb-4">
                    <select class="tipe-soal px-3 py-2 rounded-lg border text-xs font-bold outline-none">
                        <option value="PG">Pilihan Ganda</option>
                        <option value="Essay">Essay</option>
                    </select>
                    <input type="number" class="skor-soal w-24 px-3 py-2 rounded-lg border text-xs" placeholder="Skor/Poin" value="10">
                </div>
                <input type="text" class="teks-soal w-full px-4 py-3 rounded-xl border text-sm mb-4" placeholder="Pertanyaan">
                <div class="area-pg space-y-2">
                    ${['A','B','C','D','E'].map((l,i)=>`
                        <div class="flex items-center gap-2">
                            <input type="radio" name="kunci-${qid}" value="${i}" ${i===0?'checked':''}>
                            <input type="text" class="opsi-input w-full px-3 py-1 rounded-lg border text-xs" placeholder="Opsi ${l}">
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(div);
            div.querySelector('.tipe-soal').onchange = (e) => div.querySelector('.area-pg').classList.toggle('hidden', e.target.value==='Essay');
        }

        function saveKuisBaru() {
            const title = document.getElementById('new-quiz-title').value;
            const blocks = document.querySelectorAll('.item-soal-block');
            let soalList = [];
            blocks.forEach((el, i) => {
                const tipe = el.querySelector('.tipe-soal').value;
                const teks = el.querySelector('.teks-soal').value;
                const skor = parseInt(el.querySelector('.skor-soal').value) || 0;
                let kunci = "", opsi = null;
                if(tipe === 'PG') {
                    const inp = el.querySelectorAll('.opsi-input');
                    const rad = el.querySelector('input[type="radio"]:checked').value;
                    opsi = Array.from(inp).map(x => x.value || 'Opsi');
                    kunci = opsi[rad];
                }
                soalList.push({ id: i+1, tipe, teks, skor, kunci, opsi });
            });
            db.quizzes.push({ id: Date.now(), judul: title, status: 'Aktif', soal: soalList });
            saveData();
            alert('Kuis Berhasil Disimpan!');
            renderKelolaKuis();
        }

        function renderMateri() {
            let html = `<h2 class="text-2xl font-bold text-amber-900 mb-6">Modul Pembelajaran</h2><div class="grid gap-6">`;
            db.materi.forEach(m => {
                html += `<div class="bg-white p-8 rounded-3xl shadow-sm border border-yellow-100 fade-in">
                    <h3 class="font-bold text-xl text-amber-800 mb-4">${m.judul}</h3>
                    <div class="prose text-gray-600 text-sm">${m.konten}</div>
                </div>`;
            });
            document.getElementById('content-area').innerHTML = html + `</div>`;
        }

        function hapusKuis(id) {
            if(confirm('Hapus kuis ini?')) {
                db.quizzes = db.quizzes.filter(q => q.id !== id);
                saveData();
                renderKelolaKuis();
            }
        }

        function renderPenilaianEssay() {
            let html = `<h2 class="text-2xl font-bold text-amber-900 mb-6">Koreksi Jawaban</h2>`;
            const pending = db.jawabanSiswa.filter(j => j.status === 'Pending Koreksi');
            if(pending.length === 0) {
                html += `<div class="p-12 text-center text-gray-400">Semua tugas sudah diperiksa.</div>`;
            } else {
                pending.forEach(p => {
                    const q = db.quizzes.find(z => z.id === p.quizId);
                    html += `<div class="bg-white p-6 rounded-2xl border mb-4 flex justify-between items-center">
                        <div><p class="font-bold text-amber-800">${p.student}</p><p class="text-xs">${q.judul}</p></div>
                        <button onclick="koreksiSekarang(${p.id})" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold">Beri Nilai</button>
                    </div>`;
                });
            }
            document.getElementById('content-area').innerHTML = html;
        }

        function koreksiSekarang(jid) {
            const j = db.jawabanSiswa.find(x => x.id === jid);
            const q = db.quizzes.find(z => z.id === j.quizId);
            let html = `<div class="max-w-2xl mx-auto pb-20"><h2 class="text-xl font-bold mb-6">Koreksi: ${j.student}</h2>`;
            j.detail.forEach(det => {
                const s = q.soal.find(sx => sx.id === det.id);
                html += `<div class="bg-white p-6 rounded-2xl border mb-4">
                    <p class="text-sm font-bold mb-2">${s.teks}</p>
                    <p class="text-xs bg-gray-50 p-3 rounded italic mb-3">"${det.jawabanUser}"</p>
                    ${s.tipe === 'Essay' ? 
                        `<input type="number" class="skor-koreksi w-24 border p-2 rounded text-sm" data-sid="${s.id}" value="0" max="${s.skor}"> <span class="text-xs">/ Maks ${s.skor}</span>` : 
                        `<p class="text-[10px] text-green-600 font-bold uppercase">Terhitung otomatis: ${det.skor} Poin</p>`
                    }
                </div>`;
            });
            html += `<button onclick="saveKoreksi(${jid})" class="w-full bg-blue-700 text-white py-4 rounded-xl font-bold">Simpan Penilaian</button></div>`;
            document.getElementById('content-area').innerHTML = html;
        }

        function saveKoreksi(jid) {
            const j = db.jawabanSiswa.find(x => x.id === jid);
            const inputs = document.querySelectorAll('.skor-koreksi');
            inputs.forEach(i => {
                const sid = parseInt(i.dataset.sid);
                const d = j.detail.find(dx => dx.id === sid);
                if(d) d.skor = parseInt(i.value) || 0;
            });
            j.nilai = j.detail.reduce((a,b)=>a+b.skor, 0);
            j.status = 'Selesai';
            saveData();
            alert('Nilai berhasil dikirim!');
            renderPenilaianEssay();
        }

    </script>
</body>
</html>
